<% content_for :head do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<% end %>
<div>
  <h1>Curation status charts</h1>
  <form method="get">
    <div role="group" aria-labelledby="range-label">
      <b id="range-label" style="margin-right: 1ch">Chart date range</b>
      <label for="start_day">from:</label>
      <input type="date" id="start_day" name="start_day" class="c-input__text" value="<%= @start_day.to_date %>" />
      <label for="end_day">to:</label>
      <input type="date" name="end_day" id="end_day" class="c-input__text" value="<%= @end_day.to_date %>" />
      <input type="submit" value="Apply" class="o-button__submit" style="margin-left: 1ch" />
    </div>
  </form>
  <div style="margin: 2rem 0; height: 600px;"><canvas id="dailyChart" role="img" aria-label="Daily curation stats: Line chart graphing the count of each column of the curation stats table over time."></canvas></div>
  <div style="height: 600px;"><canvas id="monthlyChart" role="img" aria-label="Monthly curation stats: Line chart graphing the count of each column of the curation stats table over time."></canvas></div>
</div>
<script>
  generate_chart(
    document.getElementById('monthlyChart').getContext('2d'),
    <%= raw @monthly_data.to_json %>,
    'Monthly curation stats'
  )
  generate_chart(
    document.getElementById('dailyChart').getContext('2d'),
    <%= raw @daily_data.to_json %>,
    'Daily curation stats'
  )

  function generate_chart(ctx, rawData, title) {
    const labels = rawData.map(d => d.period);
    const field_keys = <%= raw @field_keys.to_json %>;
    const field_names = <%= raw @field_names.to_json %>;

    const colors = [
      '#1f77b4', // blue
      '#ff7f0e', // orange
      '#2ca02c', // green
      '#d62728', // red
      '#9467bd', // purple
      '#8c564b', // brown
      '#e377c2', // pink
      '#7f7f7f', // gray
      '#bcbd22', // olive
      '#17becf', // cyan
      '#ffbb78', // light orange
      '#98df8a', // light green
      '#c5b0d5'  // lavender
    ];

    const datasets = field_keys.map((field, i) => ({
      label: field_names[i],
      data: rawData.map(d => d[field]),
      borderColor: colors[i % colors.length],
      backgroundColor: colors[i % colors.length],
      tension: 0.3,
      fill: false,
      hidden: ['aar_size', 'ppr_size', 'datasets_to_be_curated', 'datasets_unclaimed'].includes(field)
    }));

    Chart.defaults.font.family = 'KievitWeb';
    Chart.defaults.font.size = 14;

    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: {
          title: { display: true, text: title, font: { size: 20 } },
          legend: { position: 'bottom' }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Count' }
          },
          x: {
            title: { display: true, text: 'Period' }
          }
        }
      }
    })
  }
</script>
