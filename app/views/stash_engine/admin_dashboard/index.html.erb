<% @page_title = "Admin dashboard" %>
<% unaltered = @saved_search&.filters == @filters && @saved_search&.fields == @fields && (@saved_search&.search_string == @search_string || (@saved_search&.search_string.blank? && @search_string.blank?)) %>
<div class="callout">
  <p>Welcome to the beta version of the new Admin dashboard! Please send your feedback to <a href="mailto:community@datadryad.org?subject=Admin dashboard feedback">community@datadryad.org</a>.</p>
</div>
<div class="admin-dashboard-header">
  <h1 class="o-heading__level1">Admin dashboard</h1>
  <%= render partial: 'role_select' %>
</div>
<div class="admin-dashboard-buttons" style="margin-top: 0; margin-bottom: -1.5rem">
  <div class="admin-dashboard-results">
    <b role="heading" aria-level="2" id="search_head">Search results<% if @saved_search %>: <a href="/stash/account#saved" style="font-weight: normal;"><%= @saved_search.title %></a><% end %></b>
    <button type="button" class="o-button__plain-text7" id="search_open" aria-controls="search_form" aria-expanded="<%= !unaltered %>" <% unless unaltered %>hidden<% end %>><i class="fa fa-sliders" aria-hidden="true"></i>Fields and filters</button>
  </div>
  <div id="search_form" <% if unaltered %>hidden<% end %>>
    <%= form_with(url: admin_dashboard_results_path(format: :js, search: params[:search], page_size: params[:page_size]), method: 'post', local: false, class: 'admin-dashboard-form') do %>
      <%= render partial: 'fields' %>
      <%= render partial: 'filters' %>
      <div class="admin-dashboard-buttons" style="column-gap: 3ch; row-gap: 2ch">
        <div class="o-admin-form-pair" style="flex-grow: 2;">
          <label for="search-string">Search terms: </label>
          <%= search_field_tag(:q, @search_string, class: 'c-input__text', id: 'search-string', style: 'flex-grow: 2' ) %>
        </div>
        <div class="o-admin-form-pair" style="flex-grow: 2;">
          <label for="related-search">Publication IDs: </label>
          <%= search_field_tag('filters[identifiers]', @filters[:identifiers], class: 'c-input__text', id: 'related-search', style: 'flex-grow: 2' ) %>
        </div>
        <div class="admin-dashboard-results" style="margin-left: auto">
          <button type="button" class="o-button__plain-text7" id="clear_filters" title="Clear search and filters"><i class="fa fa-times" aria-hidden="true"></i>Clear</button>
          <%= submit_tag('Apply', name: nil, class: 'o-button__submit') %>
        </div>
      </div>
      </p>
    <% end %>
  </div>  
  <div class="admin-dashboard-results" id="save_buttons">
    <i class="fa fa-spin fa-circle-notch" aria-hidden="true"></i>
  </div>
  <div class="admin-dashboard-results" style="font-size: .9em;" id="count_and_export">
    <i class="fa fa-spin fa-circle-notch" aria-hidden="true"></i>
  </div>
</div>

<div id="search_results" data-load="<%= stash_url_helpers.admin_dashboard_results_path(format: :js, search: params[:search], page_size: params[:page_size], page: params[:page]) %>">
  <i class="fa fa-spin fa-circle-notch" aria-hidden="true"></i>
</div>

<script type="text/javascript">
  document.getElementById('search_open').addEventListener('click', (e) => {
    e.target.setAttribute('aria-expanded', true)
    e.target.setAttribute('hidden', true)
    document.getElementById('search_form').removeAttribute('hidden')
  })
  document.getElementById('edit_fields-help').addEventListener('click', (e) => {
    e.preventDefault()
    document.getElementById('edit_fields-form').classList.toggle('show-help')
  })
  document.getElementById('clear_filters').addEventListener('click', (e) => {
    e.preventDefault()
    const inputs = document.querySelectorAll(['#edit_filters-form input', '#search_form input[type="search"]'])
    for (const input of inputs) {
      input.value = ''
    }
    const selects = document.querySelectorAll('#edit_filters-form select')
    for (const sel of selects) {
      sel.selectedIndex = -1
    }
  })
</script>