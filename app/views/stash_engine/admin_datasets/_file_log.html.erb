<% changes = @changes.reject do |change|
  if change.object_changes['file_state']&.dig(1) == 'copied'
    true
  elsif change.object_changes['file_state']&.dig(1) == 'created' &&
    @changes.any? { |v| v.event == 'destroy' && v.object['id'] == change.object_changes['id'][1] }
    true
  elsif change.event == 'destroy'
    true
  else
    false
  end
end
%>
<table class="c-lined-table" id="curation_table_<%= @resource.id %>">
  <thead>
    <tr>
      <th>User</th>
      <th>Timestamp</th>
      <th style="width: 65%;">File changes</th>
    </tr>
  </thead>
  <tbody>
    <% changes.map do |c| %>
      <tr>
        <td><%= c.whodunnit.to_i.nonzero? ? "<a href=\"#{user_admin_profile_path(id: c.whodunnit)}\">#{c.user&.name}</a>".html_safe : 'System' %></td>
        <td><%= formatted_datetime(c.created_at) %></td>
        <td>
          <% if c.event == 'update' %>
            <% if c.object_changes.keys == ['download_filename'] %>
              Renamed <del><%= c.object_changes['download_filename'][0] %></del> &rarr; <ins><%= c.object_changes['download_filename'][1] %></ins>
            <% end %>
          <% else %>
            <%= c.object_changes['file_state']&.dig(1)&.capitalize %>:
            <% file = @resource.generic_files.find(c.object_changes['id']&.dig(1)) %>
            <% if file.original_deposit_file %>
              <a href="<%= file.original_deposit_file.uploaded_success_url %>"><%= c.object_changes['download_filename']&.dig(1) %></a>
              (<%= filesize(c.object_changes['upload_file_size']&.dig(1)) %>)
            <% else %>
              <em><%= c.object_changes['download_filename']&.dig(1) %></em>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>