<h1>New CEDAR template</h1>
<%= form_with(url: cedar_template_create_path, method: :post, local: false) do |form| -%>
  <p style="margin-top: 0; padding-top: .75rem"><label for="file-select">Upload JSON template file:</label>
  <p><input id="file-select" type="file" accept="application/json, application/ld+json, application/javascript, .json, .jsonld" /></p>
  <p id="file-preview"></p>
  <%= form.hidden_field :id, value: '', id: 'setid' %>
  <%= form.hidden_field :title, value: '', id: 'title' %>
  <%= form.hidden_field :template, value: '', id: 'json' %>
  <div class="c-input">
    <label for="word_bank_id">Word bank:</label>
    <%= form.select :word_bank_id, options_from_collection_for_select([OpenStruct.new(id: '', label: '')] + CedarWordBank.all, :id, :label, params[:word_bank_id]), {}, {class: 'c-input__select'} %>
  </div>
  <div class="c-modal__buttons-right">
    <%= submit_tag 'Submit', class: 'o-button__plain-text2' %>
    <%= button_tag 'Cancel', type: 'button', id: 'cancel_dialog', class: 'o-button__plain-text7' %>
  </div>
<% end %>

<script type="text/javascript">
  document.getElementById('file-select').addEventListener('change', () => {
    const file = document.getElementById('file-select').files[0];
    const reader = new FileReader();
    reader.addEventListener('load', () => {
      const result = JSON.parse(reader.result);
      if (!result['@id'] || !result['schema:name']) {
        document.getElementById('file-select').value = '';
        document.getElementById('file-preview').innerHTML = '<div class="callout err"><p>Not a CEDAR template file.</p></div>'
      } else {
        const setid = result['@id'].split('/').pop()
        const title = result['schema:name']
        document.getElementById('json').value = JSON.stringify(result);
        document.getElementById('setid').value = setid;
        document.getElementById('title').value = title;
        document.getElementById('file-preview').innerHTML = `<b>Template title:</b> ${title}<br/><b>Template ID:</b> ${setid}`
      }
    });
    if (file) {
      reader.readAsText(file);
    }
  })
</script>